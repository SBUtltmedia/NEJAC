<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Details Panel (Live Data)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }

        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
            vertical-align: top;
            /* For potentially long recommendation summaries */
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .details-link {
            color: #2980b9;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }

        .details-link:hover {
            text-decoration: underline;
        }

        #detailViewPanel {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            /* Increased width for table content */
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
            padding: 25px;
            z-index: 1000;
            box-sizing: border-box;
        }

        #detailViewPanel h3 {
            margin-top: 0;
            color: #3498db;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #closeDetailPanel {
            position: absolute;
            top: 15px;
            /* Adjusted for better visual balance with padding */
            right: 15px;
            /* Moved to the right */
            font-size: 24px;
            font-weight: bold;
            color: #777;
            cursor: pointer;
            line-height: 1;
        }

        /* Styling for the table inside the details panel */
        #detailTableInPanel {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #detailTableInPanel th,
        #detailTableInPanel td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }

        #detailTableInPanel th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h1>NEJAC Data Viewer</h1>

    <!-- Search Bar -->
    <div style="text-align: center; margin-bottom: 20px;">
        <input type="text" id="searchInput" placeholder="Search table..." style="padding: 10px; width: 50%; font-size: 16px; border-radius: 5px; border: 1px solid #ccc;">
    </div>

    <table>
        <thead>
            <tr>
                <th>Details</th>
                <th>Date</th>
                <th>Recommendation</th>
                <th>Full Report</th>
            </tr>
        </thead>
        <tbody id="dataTableBody">
            <!-- Table rows will be generated by JavaScript -->
        </tbody>
    </table>

    <div id="detailViewPanel">
        <h3>Detailed Information</h3>
        <span id="closeDetailPanel">&times;</span> <!-- Close button -->
        <table id="detailTableInPanel">
            <!-- Content from dets.json (<tbody>...</tbody>) will be injected here -->
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // These files must be in the same directory as the HTML file,
            // or you need to provide the correct paths.
            const urls = ["dets.json", "nejacData.json", "NejacPDF.json"];

            const requests = urls.map(url =>
                fetch(url).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                    }
                    return response.json();
                })
            );

            Promise.all(requests)
                .then(allDataFromFiles => {
                    init(allDataFromFiles);
                })
                .catch(error => {
                    console.error("Error fetching or parsing JSON data:", error);
                    const tableBody = document.getElementById('dataTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">Failed to load data. Please check the console for errors and ensure JSON files are accessible in the same directory as this HTML file.</td></tr>`;
                    }
                    const detailViewPanel = document.getElementById('detailViewPanel');
                    if (detailViewPanel) {
                        const detailTable = document.getElementById('detailTableInPanel');
                        if (detailTable) detailTable.innerHTML = '<tbody><tr><td style="color:red;">Error loading details.</td></tr></tbody>';
                    }
                });
        });

        /**
         * Handles clicks on PDF links, preventing default navigation and redirecting
         * to a dynamically constructed PDF URL based on a lookup.
         *
         * @param {Event} event - The click event object.
         * @param {Array} pdfLinksArray - An array of [nodeId, pdfFileName] pairs for lookup.
         */
        function handlePdfLinkClick(event, pdfLinksArray) {
            const targetLink = event.target.closest("a[href^='/node']");
            if (!targetLink) {
                return;
            }
            event.preventDefault();
            const hrefAttribute = targetLink.getAttribute("href");
            if (!hrefAttribute) {
                console.error("Clicked link does not have an href attribute.");
                return;
            }
            const parts = hrefAttribute.split("/");
            if (parts.length < 3 || !parts[2]) {
                console.error(`Href attribute '${hrefAttribute}' is not in the expected format '/node/ID'.`);
                alert(`The link format is unexpected. Cannot retrieve PDF.`);
                return;
            }
            const node = parts[2];

            if (!pdfLinksArray || !Array.isArray(pdfLinksArray)) {
                console.error("pdfLinksArray is not available or not an array.");
                alert("Error: PDF data is not available. Cannot open PDF.");
                return;
            }

            const pdfEntry = pdfLinksArray.find(currentPDF => currentPDF && currentPDF[0] == node);

            if (pdfEntry && pdfEntry[1]) {
                const pdfFileName = pdfEntry[1];
                window.open(`node/${pdfFileName}`, '_blank');
            } else {
                console.error(`PDF link not found in pdfLinksArray for node ID: ${node}`);
                alert(`The PDF for report ID ${node} could not be found. Please check the data or contact support.`);
            }
        }

        function init(all) {
            // The order of data in 'all' matches the order in the 'urls' array:
            // all[0] is dets.json content
            // all[1] is nejacData.json content
            // all[2] is NejacPDF.json content
            const [detailsArray, mainDataArray, pdfLinksArrayGlobal] = all; // pdfLinksArrayGlobal for clarity

            const tableBody = document.getElementById('dataTableBody');
            const detailViewPanel = document.getElementById('detailViewPanel');
            const detailTableInPanel = document.getElementById('detailTableInPanel');
            const closeButton = document.getElementById('closeDetailPanel');

            let isPanelLocked = false; // Tracks if the panel is locked by a click
            let hidePanelTimer = null; // Timer for hiding panel on mouseout
            const HIDE_DELAY = 250; // Milliseconds delay before hiding on mouseout

            if (!tableBody || !detailViewPanel || !detailTableInPanel) {
                console.error("Essential HTML elements (dataTableBody, detailViewPanel, or detailTableInPanel) are missing!");
                return;
            }

            if (!mainDataArray || !Array.isArray(mainDataArray)) {
                console.error("mainDataArray is missing or not an array. Cannot populate table.");
                tableBody.innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">Error: Main data is not available.</td></tr>`;
                return;
            }
            if (!detailsArray || !Array.isArray(detailsArray)) {
                console.error("detailsArray is missing or not an array. Details panel may not work correctly.");
                // We can still try to build the table, but details will fail.
            }

            // Attach one event listener to the detailViewPanel for event delegation.
            // This listener will handle clicks on any PDF links dynamically added to the panel.
            if (detailViewPanel) {
                detailViewPanel.addEventListener('click', function(event) {
                    handlePdfLinkClick(event, pdfLinksArrayGlobal);
                });
            }

            // Add event listener to the main table body for PDF links in the 4th column
            if (tableBody) {
                tableBody.addEventListener('click', function(event) {
                    if (event.target.classList.contains('pdf-report-link')) {
                        handlePdfLinkClick(event, pdfLinksArrayGlobal);
                    }
                });
            }

            function showAndPopulatePanel(itemIndex) {
                clearTimeout(hidePanelTimer); // Cancel any pending hide
                if (detailsArray && detailsArray[itemIndex] !== undefined) {
                    detailTableInPanel.innerHTML = detailsArray[itemIndex];
                } else {
                    detailTableInPanel.innerHTML = '<tbody><tr><td colspan="2" style="padding:10px;">Details are not available for this item.</td></tr></tbody>';
                }
                detailViewPanel.style.display = 'block';
            }

            function scheduleHidePanel() {
                if (!isPanelLocked) {
                    clearTimeout(hidePanelTimer); // Clear any existing timer before setting a new one
                    hidePanelTimer = setTimeout(() => {
                        detailViewPanel.style.display = 'none';
                    }, HIDE_DELAY);
                }
            }

            mainDataArray.forEach((itemData, index) => {
                const tr = document.createElement('tr');

                // From nejacData.json, itemData is an array:
                // e.g., [593, "2021 October", "Recommendation summary...", "272441", "Report Title"]
                // The original script.js uses the array index `ii` (here `index`) to link to `detailsArray`.
                // The first element (e.g., 593) is not used as the index for detailsArray.
                const date = itemData[1];
                const recommendationSummary = itemData[2];
                const nodeId = itemData[3]; // This is the ID for PDF lookup
                const reportTitle = itemData[4]; // This is the actual title of the report

                // Column 1: "details" Link
                const tdDetails = document.createElement('td');
                const detailLink = document.createElement('a');
                detailLink.href = "#"; // Standard practice for JS-handled links
                detailLink.className = 'details-link';
                detailLink.textContent = 'details'; // Use textContent for plain text
                // Store the 0-based index to easily retrieve the corresponding detail from detailsArray
                detailLink.dataset.itemIndex = index;

                detailLink.addEventListener('mouseover', (event) => {
                    const currentItemIndex = parseInt(event.currentTarget.dataset.itemIndex, 10);
                    showAndPopulatePanel(currentItemIndex);
                    // The click listener for PDF links is now handled by delegation
                    // on detailViewPanel, so no need to add it here repeatedly.
                });

                detailLink.addEventListener('mouseout', () => {
                    scheduleHidePanel();
                });

                detailLink.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent URL change for href="#"
                    isPanelLocked = true; // Lock the panel open
                    const currentItemIndex = parseInt(event.currentTarget.dataset.itemIndex, 10);
                    showAndPopulatePanel(currentItemIndex); // Ensure it's shown/populated
                });

                tdDetails.appendChild(detailLink);
                tr.appendChild(tdDetails);

                // Column 2: Date
                const tdDate = document.createElement('td');
                tdDate.textContent = date;
                tr.appendChild(tdDate);

                // Column 3: Recommendation Summary
                const tdRec = document.createElement('td');
                tdRec.textContent = recommendationSummary;
                tr.appendChild(tdRec);

                // Column 4: Full Report (as a clickable PDF link)
                const tdRep = document.createElement('td');
                const reportLink = document.createElement('a');
                reportLink.href = `/node/${nodeId}`; // Construct href for handlePdfLinkClick
                reportLink.textContent = reportTitle; // Display the report's title
                reportLink.className = 'pdf-report-link details-link'; // Add class for styling and event delegation
                // pdf-report-link for the click handler, details-link for similar styling
                reportLink.target = "_blank"; // Optional: open PDF in a new tab

                tdRep.appendChild(reportLink);
                tr.appendChild(tdRep);

                tableBody.appendChild(tr);
            });

            // Event listeners for the panel itself to keep it open when mouse moves onto it
            if (detailViewPanel) {
                detailViewPanel.addEventListener('mouseover', () => {
                    clearTimeout(hidePanelTimer); // Keep panel open
                });

                detailViewPanel.addEventListener('mouseout', () => {
                    scheduleHidePanel(); // Schedule hide if mouse leaves panel and it's not locked
                });
            }

            // Add event listener for the close button
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    detailViewPanel.style.display = 'none';
                    isPanelLocked = false; // Unlock the panel
                    clearTimeout(hidePanelTimer); // Clear any pending hide
                });
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const filter = searchInput.value.toLowerCase();
                    const rows = tableBody.getElementsByTagName('tr');

                    for (let i = 0; i < rows.length; i++) {
                        let displayRow = false;
                        const cells = rows[i].getElementsByTagName('td');
                        for (let j = 0; j < cells.length; j++) {
                            if (cells[j]) {
                                if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                                    displayRow = true;
                                    break; 
                                }
                            }
                        }
                        rows[i].style.display = displayRow ? "" : "none";
                    }
                });
            } else {
                console.error("Search input element not found!");
            }

        }
    </script>

</body>

</html>